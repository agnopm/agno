#!/bin/sh -e

# load our vars
. $HOME/agno/agnorc
. ./Pkgfile

# re-define vars with new info
PKGNAME=$name\#$version-$release
AGNO_WORK=$AGNO_WORK/$PKGNAME
AGNO_SOURCE=$AGNO_SOURCE/$PKGNAME
AGNO_DESTDIR=$AGNO_DESTDIR/$PKGNAME

# download source files (if necessary)
mkdir -p $AGNO_SOURCE
cd $AGNO_SOURCE
for url in $source; do
	# only download stuff that looks like a URL
	if egrep -q 'https?://'; then
		curl --ssl -L -O $url
	fi
done

# unpack files
if [ -n "$(ls -A $AGNO_SOURCE)" ]; then
	$AGNO_HOME/unboop *
fi

# create necessary dirs for build
mkdir -p $AGNO_DESTDIR $AGNO_WORK

# copy source files if there are any
if [ -n "$(ls -A $AGNO_SOURCE)" ]; then
	cp -R $AGNO_SOURCE/* $AGNO_WORK
fi

# run build function
cd $AGNO_WORK
agno_build

# gotta install that shiz diz
agno_install

# let's make a package out of the result
tar -czvf $PKGNAME.tar.gz -C $AGNO_DESTDIR .
mv $PKGNAME.tar.gz $AGNO_PACKAGES

# we're done! let's cleanup
rm -rf $AGNO_WORK
rm -rf $AGNO_DESTDIR

# notice
echo "Built '$PKGNAME' successfully (i.e. without errors)"
